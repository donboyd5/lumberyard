---
title: "Cambridge Lumberyard analysis"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook: 
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    number_sections: yes
    code_folding: hide
editor_options:
  chunk_output_type: console
---


# SETUP SECTION

```{r setup, eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

# note that eval=TRUE unless set to FALSE
# to have a chunk's output show in the html file, set include=TRUE in the chunk's options

knitr::opts_chunk$set(eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, rows.print=20)
options(width = 150)
```

```{r libraries}
library(tidyverse)
tprint <- 50  # default tibble print
options(tibble.print_max = tprint, tibble.print_min = tprint) # show up to tprint rows

# tools
library(readxl)
library(lubridate)
library(RColorBrewer)
library(RcppRoll)
library(fredr)
library(btools)
library(tidycensus)

# graphics
library(scales)
library(ggbeeswarm)
library(patchwork)
library(gridExtra)
library(ggrepel)
library(ggbreak)

# tables
library(knitr)
library(kableExtra)
library(DT)
library(gt)

# maps
library(maps)
# https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html
library(usmap)

```

```{r locations}
# dsacs <- r"(E:\data\CA_sacs/)"
# dsacs_all <- paste0(dsacs, "data/allyears/")
# 
# dj90 <- r"(E:\data\CA_j90/)"
# dj90_all <- paste0(dj90, "data/allyears/")

```

```{r constants}
#.. api keys ----
source("~/R_projects/api_keys.r", verbose=TRUE)
fredr_set_key(fred_apikey)
## Not run: 
# census_api_key(census_apikey, install = TRUE)
# First time, reload your environment so you can use the key without restarting R.
# readRenviron("~/.Renviron")
# Sys.getenv("CENSUS_API_KEY")  # check

#.. graph theme items ----
legend_none <- theme(legend.position = "None")
legend_notitle <- theme(legend.title = element_blank())
caption_left <- theme(plot.caption = element_text(hjust = 0))

#.. source notes ----
acs_source <- "American Community Survey"

```


# GOALS

The goal is to understand the current local housing situation and help inform decisions about what kind of housing might be appropriate to consider within the Lumber Yard.

I think the big questions are:
•	What does the census and other publicly available records tell us about the population and housing within Village of Cambridge (and perhaps the CCS school district catchment area of White Creek, Cambridge and Jackson and how they compare to prior censuses to see what the trends are?.  
•	What is the current status of housing in Village of Cambridge?  
•	What is needed or might be the right mix of housing options in the Village of Cambridge, generally to ensure a vibrant, dynamic, diverse, multi-generational caring rural community?  
•	Are there case studies/lessons learned from other ‘ housing developments’ that attract younger people (25-35 year olds) and entrepreneurs and remote workers to rural communities?


# DATA PREPARATION SECTION
```{r census}
# https://walker-data.com/tidycensus/articles/basic-usage.html
# load_variables() takes two required arguments: year of Census or endyear of ACS sample, and dataset name
# For decennial Census, possible dataset choices include "pl" for the redistricting files (currently the only choice for 2020), "sf1" or "sf2" (2000 and 2010) and "sf3" or "sf4" (2000 only)
#  For ACS, use either "acs1" or "acs5" for the ACS detailed tables, and append /profile for the Data Profile and /subject for the Subject Tables.

# 5-year ACS for all geographies down to the block group level starting with 2005-2009

vacs2009 <- load_variables(2009, "acs5", cache = TRUE)
vacs2014 <- load_variables(2014, "acs5", cache = TRUE)
vacs2019 <- load_variables(2019, "acs5", cache = TRUE)
vacs <- 
  bind_rows(vacs2009 %>% mutate(endyear=2009),
            vacs2014 %>% mutate(endyear=2014),
            vacs2019 %>% mutate(endyear=2019))

vacs <- vacs %>%
  group_by(name) %>%
  mutate(nfiles=n()) %>%
  ungroup

tmp <- vacs %>%
   filter(str_detect(str_to_upper(concept), "MEDIAN"))
tmp2 <- tmp %>%
  filter(str_detect(concept, coll("age", ignore_case = TRUE)))

vacs3 <- vacs %>% filter(nfiles==3) %>% select(-nfiles)
sba <- vacs3 %>%
  filter(concept=="SEX BY AGE") %>%
  group_by(name) %>%
  mutate(ulabel=label[endyear==2019]) %>%
  ungroup %>%
  mutate(sex=case_when(
    str_detect(ulabel, "Male") ~ "male",
    str_detect(ulabel, "Female") ~ "female", 
    TRUE ~ "total"),
    agegroup=str_extract(ulabel, '![^!]+$'),
    agegroup=case_when(str_detect(agegroup, "Male") ~ "all",
                       str_detect(agegroup, "Female") ~ "all",
                       str_detect(agegroup, "Total") ~ "all",
                       TRUE ~ str_sub(agegroup, 2, -1)))

count(sba, name, ulabel)
count(sba, sex)
count(sba, agegroup)

count(vacs, nfiles)

acsvars <- c("B01001_001")
# B01002_001 median age total

# median age by state in 2010
age10 <- get_decennial(geography = "state", 
                       variables = "P013001", 
                       year = 2010)


f <- function(year){
  print(year)
  get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B01002_001",
                   year=year) %>%
    setNames(str_to_lower(names(.))) %>%
    mutate(year=!!year)
}

acsdata <- map_dfr(c(2009, 2014, 2019), f)
count(acsdata, year)

acsdata %>%
  filter(str_detect(name, "Cambridge") |
           str_detect(name, "Greenwich") |
           str_detect(name, "Argyle") |
           str_detect(name, "Salem")) %>%
  ggplot(aes(year, estimate, colour=str_sub(name, 1, 10))) +
  geom_line() +
  scale_x_continuous(breaks=c(2009, 2014, 2019))

acsdata %>%
  filter(str_detect(name, "Cambridge") |
           str_detect(name, "Greenwich") |
           str_detect(name, "Argyle") |
           str_detect(name, "Salem")) %>%
  arrange(geoid, year)


zf <- function(year){
  print(year)
  get_acs(geography="zcta",
          state="NY",
          # county="Washington",
          zcta=c(12816, 12834),
          variables="B01002_001",
          year=year) %>%
    setNames(str_to_lower(names(.))) %>%
    mutate(year=!!year)
}

zacs <- map_dfr(c(2009, 2014, 2019), zf)
count(acsdata, year)

zacs <- map_dfr(c(2014, 2019), zf)
zacs <- zacs %>%
  arrange(geoid, year)

zacs %>%
  filter(str_detect(name, "Cambridge") |
           str_detect(name, "Greenwich") |
           str_detect(name, "Argyle") |
           str_detect(name, "Salem")) %>%
  ggplot(aes(year, estimate, colour=str_sub(name, 1, 10))) +
  geom_line() +
  scale_x_continuous(breaks=c(2009, 2014, 2019))



get_estimates(
  geography="county",
  product = "characteristics",
  # variables = NULL,
  breakdown = "AGEGROUP",
  state="NY",
  county="Washington",
  time_series = TRUE)

tpop <- get_estimates(
  geography="county subdivision",
  product = "characteristics",
  # variables = NULL,
  breakdown = "AGEGROUP",
  state="NY",
  county="Washington",
  time_series = TRUE)

```


```{r census_reporter}
# https://censusreporter.org/profiles/16000US3611825-cambridge-ny/

```


```{r cornell}
# https://pad.human.cornell.edu/profiles/Washington.pdf


```


# WHY DO YOUNG PEOPLE COME TO A RURAL AREA?

# HOW DO IMPORTANT CHARACTERISTICS OF THE CAMBRIDGE AREA COMPARE AND CHANGE OVER TIME?






