---
title: "Cambridge Lumberyard analysis"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook: 
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    number_sections: yes
    code_folding: hide
editor_options:
  chunk_output_type: console
---


# SETUP SECTION

```{r setup, eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

# note that eval=TRUE unless set to FALSE
# to have a chunk's output show in the html file, set include=TRUE in the chunk's options

knitr::opts_chunk$set(eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, rows.print=20)
options(width = 150)
```

```{r libraries}
library(tidyverse)
tprint <- 50  # default tibble print
options(tibble.print_max = tprint, tibble.print_min = tprint) # show up to tprint rows

# tools
library(readxl)
library(lubridate)
library(RColorBrewer)
library(RcppRoll)
library(fredr)
library(btools)
library(tidycensus)

# graphics
library(scales)
library(ggbeeswarm)
library(patchwork)
library(gridExtra)
library(ggrepel)
library(ggbreak)

# tables
library(knitr)
library(kableExtra)
library(DT)
library(gt)

# maps
library(maps)
# https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html
library(usmap)

```

```{r locations}
# dsacs <- r"(E:\data\CA_sacs/)"
# dsacs_all <- paste0(dsacs, "data/allyears/")
# 
# dj90 <- r"(E:\data\CA_j90/)"
# dj90_all <- paste0(dj90, "data/allyears/")

```

```{r constants}
#.. api keys ----
source("~/R_projects/api_keys.r", verbose=TRUE)
fredr_set_key(fred_apikey)
## Not run: 
# census_api_key(census_apikey, install = TRUE)
# First time, reload your environment so you can use the key without restarting R.
# readRenviron("~/.Renviron")
# Sys.getenv("CENSUS_API_KEY")  # check

#.. graph theme items ----
legend_none <- theme(legend.position = "None")
legend_notitle <- theme(legend.title = element_blank())
caption_left <- theme(plot.caption = element_text(hjust = 0))

#.. source notes ----
acs_source <- "American Community Survey"

```


# GOALS

The goal is to understand the current local housing situation and help inform decisions about what kind of housing might be appropriate to consider within the Lumber Yard.

I think the big questions are:
•	What does the census and other publicly available records tell us about the population and housing within Village of Cambridge (and perhaps the CCS school district catchment area of White Creek, Cambridge and Jackson and how they compare to prior censuses to see what the trends are?.  
•	What is the current status of housing in Village of Cambridge?  
•	What is needed or might be the right mix of housing options in the Village of Cambridge, generally to ensure a vibrant, dynamic, diverse, multi-generational caring rural community?  
•	Are there case studies/lessons learned from other ‘ housing developments’ that attract younger people (25-35 year olds) and entrepreneurs and remote workers to rural communities?


# DATA PREPARATION SECTION
```{r tidy_census}
# https://walker-data.com/tidycensus/articles/basic-usage.html 
# load_variables() takes two required arguments: year of Census or endyear of ACS sample, and dataset name
# For decennial Census, possible dataset choices include "pl" for the redistricting files (currently the only choice for 2020), "sf1" or "sf2" (2000 and 2010) and "sf3" or "sf4" (2000 only)
#  For ACS, use either "acs1" or "acs5" for the ACS detailed tables, and append /profile for the Data Profile and /subject for the Subject Tables.

# 5-year ACS for all geographies down to the block group level starting with 2005-2009

#.. get_acs and geography ----
# https://walker-data.com/tidycensus/articles/basic-usage.html#working-with-acs-data-1
# geography="county subdivision", state="NY", county="Washington", # gets all in county
# geography="place", state="NY", # DON'T USE COUNTY, gets all in state
# geography="school district (unified)", state="NY", # DON'T USE COUNTY, gets all
# geography="zcta", state="NY", zcta=c(12816, 12834) # DON'T USE COUNTY, gets all

# keep_geo_vars=TRUE doesn't seem to matter for what I'm doing

year <- 2019

# state
df <- get_acs(geography="state",
                   state="NY",
                   variables="B01002_001",
                   year=year)

# county
df <- get_acs(geography="county",
              state="NY",
              county=c("Albany", "Saratoga", "Warren", "Washington"),
              variables="B01002_001",
              year=year)

df <- get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B01002_001",
                   year=year)


# county subdivisions
df <- get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B01002_001",
                   year=year) 
df <- get_acs(geography="county subdivision",
                   state="36",
                   county="115",
                   variables="B01002_001",
                   year=year) 
# 3611502561 Argyle town, Washington County, New York
# 3611511836 Cambridge town, Washington County, New York
# 3611522656 Easton town, Washington County, New York
# 3611530686 Greenwich town, Washington County, New York
# 3611538143 Jackson town, Washington County, New York
# 3611564782 Salem town, Washington County, New York
# 3611581578 White Creek town, Washington County, New York



# places
df <- get_acs(geography="place",
                   state="NY",
                   # county="Washington",
                   variables="B01002_001",
                   year=year)
# 3602550 Argyle village, New York
# 3611825 Cambridge village, New York
# 3630675 Greenwich village, New York
# 3664771 Salem CDP, New York
# 3665255 Saratoga Springs city, New York
# 3665750 Schuylerville village, New York
places <- c("3602550", "3611825", "3630675", "3664771", "3665255", "3665750")


# school districts
df <- get_acs(geography="school district (unified)",
              state="NY",
              # county="Washington",
              variables="B01002_001", # Estimate!!Median age!!Total
              year=year)
# 3603210 Argyle Central School District, New York
# 3606210 Cambridge Central School District, New York
# 3612900 Greenwich Central School District, New York
# 3625470 Salem Central School District, New York
# 3625770 Saratoga Springs City School District, New York
# 3626160 Schuylerville Central School District, New York
csds <- c("3603210", "3606210", "3612900", "3625470", "3625770", "3626160")

# zip code tablulations
df <- get_acs(geography="zcta",
          state="NY",
          zcta=c(12816, 12834),
          variables="B01002_001",
          year=year)


vacs2009 <- load_variables(2009, "acs5", cache = TRUE)
vacs2014 <- load_variables(2014, "acs5", cache = TRUE)
vacs2018 <- load_variables(2018, "acs5", cache = TRUE)
vacs2019 <- load_variables(2019, "acs5", cache = TRUE)
vacs <- 
  bind_rows(vacs2009 %>% mutate(endyear=2009),
            vacs2014 %>% mutate(endyear=2014),
            vacs2018 %>% mutate(endyear=2018),
            vacs2019 %>% mutate(endyear=2019))

tmp <- count(vacs, concept)
tmp %>% filter(str_detect(concept, coll("veteran", ignore_case = TRUE)))
djb1 <- tmp %>% filter(str_detect(concept, coll("percent", ignore_case = TRUE)), year %in% 2018:2019)

# possible concepts of interest
# AGE BY DISABILITY STATUS BY HEALTH INSURANCE COVERAGE STATUS
# AGE BY IMPUTATION OF INDEPENDENT LIVING DIFFICULTY FOR THE CIVILIAN NONINSTITUTIONALIZED POPULATION 15 YEARS AND OVER
# AGE BY NUMBER OF DISABILITIES
# AGE BY PRESENCE OF A COMPUTER AND TYPES OF INTERNET SUBSCRIPTION IN HOUSEHOLD
# AGE BY VETERAN STATUS BY EMPLOYMENT STATUS FOR THE CIVILIAN POPULATION 18 TO 64 YEARS
# AGE OF HOUSEHOLDER BY GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS

s <- "AGE OF HOUSEHOLDER BY GROSS RENT AS A PERCENTAGE"
s <- "GROSS RENT AS A PERCENTAGE"
s <- "PERCENTAGE OF HOUSEHOLD INCOME"

pvars <- vacs %>% filter(str_detect(concept, coll(s, ignore_case = TRUE)))
pvars2 <- pvars %>% filter(str_detect(concept, coll("owner cost", ignore_case = TRUE)),
                 label=="Estimate!!Total")
pvars3 <- pvars %>% filter(label=="Estimate!!Total")
# B25071_001 Estimate!!Median gross rent as a percentage of household income MEDIAN GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS

vacs <- vacs %>%
  group_by(name) %>%
  mutate(nfiles=n()) %>%
  ungroup

tmp <- vacs %>%
   filter(str_detect(str_to_upper(concept), "MEDIAN"))
tmp2 <- tmp %>%
  filter(str_detect(concept, coll("age", ignore_case = TRUE)))

vacs3 <- vacs %>% filter(nfiles==3) %>% select(-nfiles)
sba <- vacs3 %>%
  filter(concept=="SEX BY AGE") %>%
  group_by(name) %>%
  mutate(ulabel=label[endyear==2019]) %>%
  ungroup %>%
  mutate(sex=case_when(
    str_detect(ulabel, "Male") ~ "male",
    str_detect(ulabel, "Female") ~ "female", 
    TRUE ~ "total"),
    agegroup=str_extract(ulabel, '![^!]+$'),
    agegroup=case_when(str_detect(agegroup, "Male") ~ "all",
                       str_detect(agegroup, "Female") ~ "all",
                       str_detect(agegroup, "Total") ~ "all",
                       TRUE ~ str_sub(agegroup, 2, -1)))

count(sba, name, ulabel)
count(sba, sex)
count(sba, agegroup)

count(vacs, nfiles)

acsvars <- c("B01001_001")
acsvars <- c("B25071_001")
# B01002_001 median age total
# B25093_001 AGE OF HOUSEHOLDER BY SELECTED MONTHLY OWNER COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS
# B25101_001 Estimate!!Total MORTGAGE STATUS BY MONTHLY HOUSING COSTS AS A PERCENTAGE

# median age by state in 2010
age10 <- get_decennial(geography = "state", 
                       variables = "P013001", 
                       year = 2010)


f <- function(year){
  print(year)
  get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B25101_001",
                   year=year) %>%
    setNames(str_to_lower(names(.))) %>%
    mutate(year=!!year)
}

acsdata <- map_dfr(c(2009, 2014, 2019), f)
acsdata <- map_dfr(c(2014, 2019), f)
count(acsdata, year)

acsdata %>%
  filter(str_detect(name, "Cambridge") |
           str_detect(name, "Greenwich") |
           str_detect(name, "Argyle") |
           str_detect(name, "Salem")) %>%
  ggplot(aes(year, estimate, colour=str_sub(name, 1, 10))) +
  geom_line() +
  scale_x_continuous(breaks=c(2009, 2014, 2019))

acsdata %>%
  filter(str_detect(name, "Cambridge") |
           str_detect(name, "Greenwich") |
           str_detect(name, "Argyle") |
           str_detect(name, "Salem")) %>%
  arrange(geoid, year)


zf <- function(year){
  print(year)
  get_acs(geography="zcta",
          state="NY",
          # county="Washington",
          zcta=c(12816, 12834),
          variables="B01002_001",
          year=year) %>%
    setNames(str_to_lower(names(.))) %>%
    mutate(year=!!year)
}

zacs <- map_dfr(c(2009, 2014, 2019), zf)
count(acsdata, year)

zacs <- map_dfr(c(2014, 2019), zf)
zacs <- zacs %>%
  arrange(geoid, year)

zacs %>%
  filter(str_detect(name, "Cambridge") |
           str_detect(name, "Greenwich") |
           str_detect(name, "Argyle") |
           str_detect(name, "Salem")) %>%
  ggplot(aes(year, estimate, colour=str_sub(name, 1, 10))) +
  geom_line() +
  scale_x_continuous(breaks=c(2009, 2014, 2019))



get_estimates(
  geography="county",
  product = "characteristics",
  # variables = NULL,
  breakdown = "AGEGROUP",
  state="NY",
  county="Washington",
  time_series = TRUE)

tpop <- get_estimates(
  geography="county subdivision",
  product = "characteristics",
  # variables = NULL,
  breakdown = "AGEGROUP",
  state="NY",
  county="Washington",
  time_series = TRUE)


# "county subdivision" -- state, county
# school district (unified) -- state

year <- 2019
df <- get_acs(geography="school district (unified)",
              state="NY",
              # county="Washington",
              variables="B01002_001", # Estimate!!Median age!!Total
              year=year) %>%
    setNames(str_to_lower(names(.))) %>%
    mutate(year=!!year)

df2 <- df %>%
  filter(geoid %in% csds)
df2

argcsd <- "3603210"
cambcsd <- "3606210"
gwcsd <- "3612900"
salemcsd <- "3625470"
saracsd <- "3625770"
schuycsd <- "3626160"
csds_codes <- c(argcsd, cambcsd, gwcsd, salemcsd, saracsd, schuycsd)


```


```{r tidy_census_full}
# define variables of interest

# build a full variable list and clean it up so that it has uniform titles
vacs2009 <- load_variables(2009, "acs5", cache = TRUE)
vacs2014 <- load_variables(2014, "acs5", cache = TRUE)
vacs2018 <- load_variables(2018, "acs5", cache = TRUE)
vacs2019 <- load_variables(2019, "acs5", cache = TRUE)
vacs <- 
  bind_rows(vacs2009 %>% mutate(endyear=2009),
            vacs2014 %>% mutate(endyear=2014),
            vacs2018 %>% mutate(endyear=2018),
            vacs2019 %>% mutate(endyear=2019))

# create uniform labels based on latest year and count # years
uvacs <- vacs %>%
  separate(name, c("tableid", "vnum"), remove=FALSE) %>%
  group_by(name) %>%
  arrange(endyear) %>%
  mutate(nyears=n(), ulabel=label[endyear==max(endyear)]) %>%
  ungroup %>%
  # there are never more than 8 parts to the uniform lable
  separate(ulabel, into=paste0("ulab", 1:8), sep="!!", remove=FALSE)

```


```{r tidy_census_define_vars}
sexage1 <- uvacs %>%
  filter(tableid=="B01001", endyear==2019)
sexage <- sexage1 %>%
  select(tableid, concept, name, nyears, ulabel, sex=ulab3, agegroup=ulab4) %>%
  mutate(sex=str_remove_all(sex, ":") %>% str_to_lower(),
         agegroup=ifelse(is.na(agegroup), "total", agegroup)) %>%
  filter(sex %in% c("male", "female"))

geos <- read_delim(
"geotype;geoid;geoname

state; 36; New York

county; 36001; Albany County, New York
county; 36091; Saratoga County, New York
county; 36113; Warren County, New York
county; 36115; Washington County, New York

cosub; 36115; Washington County, New York

place; 3602550; Argyle village, New York
place; 3611825; Cambridge village, New York
place; 3630675; Greenwich village, New York
place; 3664771; Salem village, New York
place; 3665750; Schuylerville village, New York

school; 3603210; Argyle Central School District, New York
school; 3606210; Cambridge Central School District, New York
school; 3612900; Greenwich Central School District, New York
school; 3625470; Salem Central School District, New York
school; 3625770; Saratoga Springs City School District, New York
school; 3626160; Schuylerville Central School District, New York

", col_types=cols(.default = col_character()), trim_ws=TRUE
)
geos

# df %>% select(geotype, geoid, name) %>% 
#   distinct %>% 
#   arrange(geotype, geoid) %>%
#   write_delim(here::here("data", "test.out"), delim=";", quote="needed")


```



```{r tidy_census_safe_functions}
# functions to safely get data (without erroring if it doesn't exist)

get_acsvars <- function(acsvars, years, dict=uvacs, geos=geos){
  
  get_geo <- function(geotype, year, subvars){
    print(geotype)
    if(geotype=="state"){
      df <- get_acs(geography="state",
                    state=states,
                    variables=subvars,
                    year=year)
      } else if(geotype=="county") {
        # print(states); print(counties); print(subvars); print(year)
        df <- get_acs(geography="county",
              state=states,
              county=counties,
              variables=subvars,
              year=year)
       } else if(geotype=="cosub"){
          df <- get_acs(geography="county subdivision",
                        state=cosubs_state,
                        county=cosubs_county,
                        variables=subvars,
                   year=year)
        } else if(geotype=="place"){
          df <- get_acs(geography="place",
                   state=states,
                   variables=subvars,
                   year=year)
        } else if(geotype=="school"){
          df <- get_acs(geography="school district (unified)",
                   state=states,
                   variables=subvars,
                   year=year)
        } else df <- tibble(GEO=NA_character_,
                            GEOID=NA_character_,
                            NAME=NA_character_,
                            variable=NA_character_,
                            estimate=NA_real_,
                            moe=NA_real_)
        
        df <- df %>%
          setNames(str_to_lower(names(.))) %>%
          mutate(geotype=!!geotype,
                 year=!!year)  %>%
          select(geotype, year, geoid, geoname=name, variable, estimate, moe)
        
        df <- df %>%
          # drop non-cosub govts that are not specified in the geos file (revisit)
          left_join(geos %>% 
              select(geoid, geotype, geos_geoname=geoname) %>%
              mutate(ingeo=TRUE),
            by=c("geoid", "geotype")) %>%
          # drop non-cosub govts that are not specified in the geos file (revisit)
          filter((geotype=="cosub") | ingeo) %>%
          select(-ingeo)
        return(df)
        }
  
  get_year <- function(year, acsvars, geos, dict){
    # the main program -- direct action for a single year
    print(year)
    subvars <- intersect(acsvars, dict$name[dict$endyear==year])
    map_dfr(geotypes, get_geo, year, subvars)
  }
  
  # these variables are available throughout the function
  geotypes <- unique(geos$geotype)
  states <- geos %>% filter(geotype=="state") %>% .$geoid
  counties <- geos %>% 
    filter(geotype=="county") %>% 
    mutate(counties=str_sub(geoid, 3, 5)) %>%
    .$counties
  places <- geos %>% filter(geotype=="place") %>% .$geoid
  cosubs <- geos %>% filter(geotype=="cosub") %>% .$geoid
  cosubs_state <- str_sub(cosubs, 1, 2)
  cosubs_county <- ifelse(nchar(cosubs)==5, str_sub(cosubs, 3, 5), NULL)
  # print(cosubs_county)
  df <- map_dfr(years, get_year, acsvars, geos, dict)
  df
}

acsvars <- c("B01002_001", sexage$name)

df1 <- get_acsvars(acsvars=acsvars,
                  years=c(2009, 2014, 2019),
                  dict=uvacs, 
                  geos=geos)
df1
count(df1 %>% filter(geotype=="school"), geotype, geoid, geoname)
count(df1 %>% filter(geotype=="state"), geotype, geoid, geoname)
count(df1, geotype)
count(df1, geotype, geoid, geoname)
# 25 place   3664771    Salem CDP, New York                                49
# 26 place   3664771    Salem village, New York                            98

df2 %>% 
  filter(geoid=="3602550") %>%
  group_by(geoid, geotype, year, geoname) %>%
  summarise(n=n())

df1 %>% 
  filter(str_detect(geoname, "Argyle")) %>%
  group_by(geotype, geoid, year, geoname) %>%
  summarise(n=n())


count(df1, geotype)
count(df1 %>% filter(geotype=="school"), geotype, geoid, geoname)

geos %>%
  filter(geotype=="school")


df <- get_acs(geography="school district (unified)",
              state="NY",
              variables="B01002_001", # Estimate!!Median age!!Total
              year=year) %>%
  filter()



  # these variables are available throughout the function
  geotypes <- unique(geos$geotype)
  states <- geos %>% filter(geotype=="state") %>% .$geoid
  counties <- geos %>% 
    filter(geotype=="county") %>% 
    mutate(counties=str_sub(geoid, 3, 5)) %>%
    .$counties
  places <- geos %>% filter(geotype=="place") %>% .$geoid
  cosubs <- geos %>% filter(geotype=="cosub") %>% .$geoid
  cosubs_state <- str_sub(cosubs, 1, 2)
  cosubs_county <- ifelse(nchar(cosubs)==5, str_sub(cosubs, 3, 5), NULL)
  # print(cosubs_county)
  dict <- uvacs
  year <- 2009
  subvars <- intersect(acsvars, dict$name[dict$endyear==year])
  
  df <- get_acs(geography="county",
      state=states,
      county=counties,
      variables=subvars,
      year=year, show_call = TRUE)
  
  df <- get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B01002_001",
                   year=year, show_call = TRUE)


  df <- get_acs(geography="county",
              state="NY",
              county=c("115"),
              variables="B01002_001",
              year=year, show_call = TRUE)
  
  # geotypes <- tribble(~type, ~name,
#                     "state", "state",
#                     "county", "county",
#                     "cosub", "county subdivision",
#                     "place", "place",
#                     "school", "school district (unified)",
#                     "zcta", "zcta"
#                     )
  

# state
df <- get_acs(geography="state",
                   state="NY",
                   variables="B01002_001",
                   year=year)

# county
df <- get_acs(geography="county",
              state="NY",
              county=c("Albany", "Saratoga", "Warren", "Washington"),
              variables="B01002_001",
              year=year)



df <- get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B01002_001",
                   year=year)


# county subdivisions
df <- get_acs(geography="county subdivision",
                   state="NY",
                   county="Washington",
                   variables="B01002_001",
                   year=year) 
# 3611502561 Argyle town, Washington County, New York
# 3611511836 Cambridge town, Washington County, New York
# 3611522656 Easton town, Washington County, New York
# 3611530686 Greenwich town, Washington County, New York
# 3611538143 Jackson town, Washington County, New York
# 3611564782 Salem town, Washington County, New York
# 3611581578 White Creek town, Washington County, New York



# places
df <- get_acs(geography="place",
                   state="NY",
                   # county="Washington",
                   variables="B01002_001",
                   year=year)
# 3602550 Argyle village, New York
# 3611825 Cambridge village, New York
# 3630675 Greenwich village, New York
# 3664771 Salem CDP, New York
# 3665255 Saratoga Springs city, New York
# 3665750 Schuylerville village, New York
places <- c("3602550", "3611825", "3630675", "3664771", "3665255", "3665750")


# school districts
df <- get_acs(geography="school district (unified)",
              state="NY",
              #  county="Washington",
              variables="B01002_001", # Estimate!!Median age!!Total
              year=year)
# 3603210 Argyle Central School District, New York
# 3606210 Cambridge Central School District, New York
# 3612900 Greenwich Central School District, New York
# 3625470 Salem Central School District, New York
# 3625770 Saratoga Springs City School District, New York
# 3626160 Schuylerville Central School District, New York
csds <- c("3603210", "3606210", "3612900", "3625470", "3625770", "3626160")

# zip code tablulations
df <- get_acs(geography="zcta",
          state="NY",
          zcta=c(12816, 12834),
          variables="B01002_001",
          year=year)


```


```{r get_acs_all}

```





```{r census_reporter}
# https://censusreporter.org/profiles/16000US3611825-cambridge-ny/

```


```{r cornell}
# https://pad.human.cornell.edu/profiles/Washington.pdf


```


# WHY DO YOUNG PEOPLE COME TO A RURAL AREA?

# HOW DO IMPORTANT CHARACTERISTICS OF THE CAMBRIDGE AREA COMPARE AND CHANGE OVER TIME?






